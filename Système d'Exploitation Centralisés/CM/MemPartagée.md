# Création de Mémoire partagée

`$ ipcs`: montre la liste des zones de mémoire partagée  
`$ ipcrm`: permet de supprimer une zone de mémoire partagée

## Créer un segment de mémoire: `shmget()`

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int shmget(key_t key, size_t size, int shmflg);
```

*key* point de rdv. Éventuellement égal à IPC_PRIVATE  
*size* taille e ctets du segment de mémoire partagée  
*shmflg* drapeaux (droits d'accès, sémaphores) 

## Attacher un segment: `shmat()`

Attache le segment de mémoire partagée. Il donne un pointeur du r le début du segment.

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

void *shmat(int shmid, const void *shmaddr, int shmflg);
```

*shmid* identificateur de mémoire partagée  
*shmaddr* adresse sur laquelle attacher le segment (si = 0, le système décide tout seul)  
*shmflg* drapeaux. SHM_RDONLY

## Pour détacher un segment: `shmdt()`  

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

void *shmdt(void *shmaddr);
```

## Contrôle des segments de mémoire partagée: `shmctl()`

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

void *shmctl(int shmid, int cmd, struct shmid_ds *buf);
```

*shmid* identificateur  
*cmd* commande à exécuter (IPC_RMID: détruire le segement...)  
*shmid_ds*:  en ce qui nous concerne.

## Exemple de programme

```c
#include <stdio.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/wait.h>
#define ERR -1

int main(void) {
    int shmid;
    int *shared_int;
    pid_t pid;
    if (shmid = shmget(IPC_PRIVATE, sizeof(int), 0600) == ERR) perror("shget"), exit(2);
    if ((shared_int = (int*) shmat(shmid, 0, 0)) == NULL) perror("Attach"), exit(3);
    if((pid1 = fork()) == ERR) perror("detach son"), exit(4);
    if(!pid) {
        printf("la valeur est: %d\n", *shared_int);
        *shared_int = 1664;
        if(shmdt((char*)shared_int) == ERR) perror("detach son"), exit(4);
    }
    else {
        wait(NULL);
        printf("la valeur est: %d\n", *shared_int);
        if(shmdt((char*) shared_int) == ERR) perror("detach"), exit(5);
        if(shmctl(shmid, IPC_RMID, 0) == ERR) perror("shmctl"), exit(6);
    }
    return 0;
}
