// Deux processus: 
// l'un lit un entier puis l'envoie à l'autre 
// qui le met au carré l'envoie au père
// qui l'affiche

#include <fcntl.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <signal.h>

#define ERR -1
#define errsys(n) perror(taberr[n]), exit(n)

char* taberr[]={"","",""};

int main(void) {
    pid_t pid;
    int tube[2];

    if(pipe(tube)==ERR) errsys(2);

    if((pid = fork()) == ERR) errsys(1);
    if(pid){
        int n;

        printf("Give a number: ");
        scanf("%d%*[^\n]%*c",&n)
        || scan("%*[^0-9-]%d%*[^\n]%c", &n);
        write(tube[1], &n, sizeof(int));

        wait(NULL);
        read(tube[0], &n, sizeof(int));
        printf("Its square is : %d\n", n);
    }
    else {
        int n2;

        read(tube[0], &n2, sizeof(int));
        n2 *= n2;
        write(tube[1], &n2, sizeof(int));

        close(tube[0]);
        close(tube[1]);
    }
    exit(0);
}

// le père lit en boucle
// le fils répond en boucle
// Pas d'interférence

pid_t pid;
int pere=0;
int tube[2];

int rien(int s){
    return;
}

int end(int s){
    if(pere) kill(pid, SIGINT);
    close(tube[0]);
    close(tube[1]);
    exit(0);
}

int main2(void) {

    signal(SIGUSR1,rien);
    signal(SIGINT,end);
    if(pipe(tube)==ERR) errsys(2);

    if((pid = fork()) == ERR) errsys(1);
    if(pid){
        int n = 1;
        pere=1;
        for(;;){
            printf("Give a number: ");
            while(!scanf("%d%*[^\n]%*c",&n) || scan("%*[^0-9-]%d%*[^\n]%c", &n));
            write(tube[1], &n, sizeof(int));
            kill(pid, SIGUSR1);
            pause();
            read(tube[0], &n, sizeof(int));
            printf("Its square is : %d\n", n);
        }
    }
    else {
        int n2;
        for(;;){
            pause();
            read(tube[0], &n2, sizeof(int));
            n2 *= n2;
            write(tube[1], &n2, sizeof(int));
            kill(getppid(), SIGUSR1);
        }
    }
    exit(0);
}