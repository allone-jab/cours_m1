#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <stdlib.h>
#include <errno.h>

struct sembuf UP={0,+1,0};
struct sembuf DW={0,-1,0};

#define ERR -1

#define err(s,n) {fprintf(stderr,"In file"__FILE__", at line %d", __LINE__); perror(#s); exit(n);}

#define new(nom,path,code) key_t k##nom=ftok(path,code); int sem##nom;

#define init(nom,nb,init)\
    { int creer=1,i;\
    if(k##nom==ERR) err(Problem during the generation of the key of semaphore sem##nom,6);\
    sem##nom=semget(k##nom, nb, IPC_CREAT|IPC_EXCL|0600);\
    if(sem##nom==ERR) creer=0,sem##nom=semget(k##nom,nb,0600);\
    if(sem##nom==ERR) err(Probem during the creation of semaphore sem##nom, 1);\
    if(creer)\
        for(i=0; i<nb;i++) if(semctl(sem##nom, i, SETVAL, init) == ERR) err(Problem during initialization of semaphore sem##nom, 2);\
    }

#define V(nom,num) UP.sem_num=num;if(semop(sem##nom,&UP,1)==ERR) err(Problem during V operation on the semaphore sem##nom, 2);

#define P(nom,num) DW.sem_num=num;if(semop(sem##nom,&DW,1)==ERR) err(Problem during V operation on the semaphore sem##nom, 4);

#define del(nom) if((semctl(sem##nom,1,IPC_RMID)==ERR)&&(errno!=EPERM)) err(Problem durinf the deletion of semaphore sem##nom, 5);