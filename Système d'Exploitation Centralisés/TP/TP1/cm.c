#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include "../my_lib/errors.h"

/* TOTAL OF ALL COUNTERS */
int total_chars = 0;
int total_words = 0;
int total_lines = 0;

/* Prints the counters for the current file and add the counters to the total.*/
void recap(char* file, int chars, int words, int lines, int opt){
    if(!(opt >> 3 & 1)){
        if(opt >> 2 & 1) { printf("%d ", lines); }
        if(opt >> 1 & 1) { printf("%d ", words); }
        if(opt >> 0 & 1) { printf("%d ", chars); }
        if(!(opt >> 2 & 1) && !(opt >> 1 & 1) && !(opt >> 0 & 1)){
            printf("%d %d %d ", lines, words, chars);
        }
        printf("%s\n", file);
    }
    total_chars += chars;
    total_words += words;
    total_lines += lines;
}

void count_file(char* file, int opt){
    int chars, words, lines; /* COUNTERS */
    int fd; /* FILE DESCRIPTOR */
    char curr; /* CHARACTER BEING READ*/

    if((fd = open(file, O_RDONLY)) == ERR){
        perror("Open error");
        exit(OPEN_ERROR);
    }   

    chars = 0;
    words = 0;
    lines = 0;

    while(read(fd, &curr, 1) > 0){
        chars++;
        if(curr == ' ' || curr == '\t') words++;
        else if(curr == '\n') lines++;
    }
    close(fd);
    recap(file, chars, words, lines, opt);
}

int main(int argc, char** argv) {
    char curr; /* CHARACTER BEING READ*/
    unsigned long opt = 0;
 
    while(--argc > 1 && (*++argv)[0] == '-') {
        while((curr = *++argv[0]))
            switch (curr) {
                case 'c':
                    opt ^= (-1 ^ opt) & (1UL << 0);
                    break;
                case 'm':
                    opt ^= (-1 ^ opt) & (1UL << 1);
                    break;
                case 'l':
                    opt ^= (-1 ^ opt) & (1UL << 2);
                    break;
                case 't':
                    opt ^= (-1 ^ opt) & (1UL << 3);
                    break;
                case 'i':
                    opt ^= (-1 ^ opt) & (1UL << 4);
                    break;
                default:
                    printf("cm: unknown option -- %c", curr);
                    exit(UNKN_OPTION);
            }
    }

    do {
        count_file(*argv, opt);
    } while(argc-- > 1 && (*argv++) != NULL);

    if(!(opt >> 4 & 1)) printf("%d %d %d total\n",total_lines , total_words, total_chars);
}