#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include "../my_lib/errors.h"

void tete(char* file, int opt, int units) {
    int fd; /* FILE DESCRIPTOR */
    char curr;
    int ind = 0;

    if((fd = open(file, O_RDONLY)) == -1) {
        perror("Read error.");
        exit(READ_ERROR);
    }

    while(read(fd, &curr, 1) > 0 && ind < units){
        if(opt >> 0 & 1) ind++;
        else if(curr == '\n') ind++;
        printf("%c", curr);
    };
    printf("\n");
    close(fd);
}

int main(int argc, char** argv) {
    char curr;
    int opt = 0, nUnits = 10;

    while(--argc > 1 && (*++argv)[0] == '-') {
        
        while((curr = *++argv[0]))
            switch (curr) {
                case 'c':
                    opt ^= (-1 ^ opt) & (1UL << 0);
                    nUnits = atoi(*++argv);
                    curr = *++argv[0];
                    break;
                case 'l':
                    if(opt >> 0 & 1){
                        perror("Bad arguments combination.");
                        exit(ARG_ERROR);
                    }
                    opt ^= (-1 ^ opt) & (1UL << 1);
                    nUnits = atoi(*++argv);
                    break;
                case 's':
                    opt ^= (-1 ^ opt) & (1UL << 2);
                    break;
                case 'v':
                    opt ^= (-1 ^ opt) & (1UL << 3);
                    break;
                default:
                    printf("tete: unknown option -- %c", curr);
                    exit(UNKN_OPTION);
            }
    }

    for(;argc;argc--)
        tete(argv[argc], opt, nUnits);

    return 0;
}